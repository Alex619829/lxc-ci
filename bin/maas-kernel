#!/bin/sh
export DEBIAN_FRONTEND="noninteractive"
for i in $(echo "${1}" | tr ',' ' '); do
case "$i" in
      default)
        echo "===> No kernel changes needed"
        exit 0
      ;;

      cgroup2)
        echo "===> CGroup2"

        # shellcheck disable=SC2016
        echo 'GRUB_CMDLINE_LINUX="${GRUB_CMDLINE_LINUX} systemd.unified_cgroup_hierarchy=1"' > /etc/default/grub.d/99-cgroup.cfg
        update-grub
      ;;

      swapaccount)
        echo "===> CGroup swap accounting"

        # shellcheck disable=SC2016
        echo 'GRUB_CMDLINE_LINUX="${GRUB_CMDLINE_LINUX} swapaccount=1"' > /etc/default/grub.d/99-cgroup-swap.cfg
        update-grub
      ;;

      iommu)
        echo "===> Enabling iommu"

        # shellcheck disable=SC2016
        echo 'GRUB_CMDLINE_LINUX="${GRUB_CMDLINE_LINUX} iommu=pt intel_iommu=on amd_iommu=on"' > /etc/default/grub.d/99-iommu.cfg
        update-grub
      ;;

      nvidia)
        echo "===> Installing the NVIDIA driver"

        apt-get update
        apt-get install nvidia-utils-440 linux-modules-nvidia-440-generic libnvidia-compute-440 --yes

        echo "blacklist nouveau" > /etc/modprobe.d/blacklist-nouveau.conf
        echo "options nouveau modeset=0" >> /etc/modprobe.d/blacklist-nouveau.conf
        sudo update-initramfs -u
      ;;

      amd-vgpu)
        echo "===> Installing the AMD vGPU driver"

        apt-get update
        apt-get install build-essential --yes
        git clone https://github.com/kasperlewau/MxGPU-Virtualization
        (cd MxGPU-Virtualization && ./gim.sh)
        depmod -a

        echo "blacklist amdgpu" > /etc/modprobe.d/blacklist-amdgpu.conf
        sudo update-initramfs -u
      ;;

      nvidia-vgpu)
        echo "===> Installing the NVIDIA vGPU driver"

        apt-get update
        apt-get install build-essential --yes
        curl http://canonical-lxd.stgraber.org/nvidia/v12.2-beta/nvidia-vgpu-kvm.run -o /root/nvidia-vgpu-kvm.run
        chmod +x /root/nvidia-vgpu-kvm.run
        /root/nvidia-vgpu-kvm.run -q -s

        echo "blacklist nouveau" > /etc/modprobe.d/blacklist-nouveau.conf
        echo "options nouveau modeset=0" >> /etc/modprobe.d/blacklist-nouveau.conf
        sudo update-initramfs -u
      ;;

      ubuntu)
        echo "===> Ensuring default kernel is up to date"

        apt-get update
        apt-get dist-upgrade --yes
      ;;

      ubuntu-proposed)
        echo "===> Installing the current proposed kernel"

        # shellcheck disable=SC1091
        . /etc/os-release
        echo "deb http://us.archive.ubuntu.com/ubuntu ${UBUNTU_CODENAME}-proposed main restricted universe multiverse" > /etc/apt/sources.list.d/proposed.list
        apt-get update
        apt-get dist-upgrade --yes
      ;;

      ubuntu-bootstrap)
        echo "===> Installing the current bootstrap kernel"

        apt-get update
        apt-get install software-properties-common --yes
        apt-add-repository ppa:canonical-kernel-team/bootstrap --yes
        apt-get dist-upgrade --yes
      ;;

      ubuntu-unstable)
        echo "===> Installing the current unstable kernel"

        apt-get update
        apt-get install software-properties-common --yes
        apt-add-repository ppa:canonical-kernel-team/unstable --yes
        apt-get dist-upgrade --yes
      ;;

      daily)
        echo "===> Installing a mainline daily build"

        wget -e robots=off -r --no-parent -A '*all*.deb' -R '*lpae*' -R '*lowlatency*' https://kernel.ubuntu.com/~kernel-ppa/mainline/daily/current/
        wget -e robots=off -r --no-parent -A '*amd64*.deb' -R '*lpae*' -R '*lowlatency*' https://kernel.ubuntu.com/~kernel-ppa/mainline/daily/current/
        apt-get update
        apt-get install kernel.ubuntu.com/~kernel-ppa/mainline/daily/current/*.deb --yes
        apt-get dist-upgrade --yes
      ;;

      *)
        echo "Unsupported kernel requested: ${1}"
        exit 1
      ;;
    esac
done

reboot
