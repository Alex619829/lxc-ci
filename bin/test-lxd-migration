#!/bin/sh
set -eu

series=${1:-xenial-updates}
track=${2:-latest}
channel=${3:-stable}

export DEBIAN_FRONTEND=noninteractive

cleanup() {
    if [ "${FAIL}" = "1" ]; then
        echo ""
        echo "Test failed"
        exit 1
    fi
}

launch() {
    if [ "${series}" = "xenial-updates" ]; then
        lxc launch images:alpine/edge "${1}"
    else
        lxc launch images:alpine/edge "${1}" -n lxdbr0 -s "${2}"
    fi
}

FAIL=0
trap cleanup EXIT HUP INT TERM

# Make sure we're up to date
while :; do
    apt-get update && break
    sleep 10
done

while :; do
    apt-get dist-upgrade --yes && break
    sleep 10
done

# Install dependencies
apt-get install --no-install-recommends --yes jq zfsutils-linux thin-provisioning-tools

# Configure LXD
lxd waitready --timeout=120

# Base configuration
lxc network create lxdbr0
lxc storage create dir dir source=/mnt
lxc storage create zfs zfs
lxc storage create lvm lvm
lxc storage create btrfs btrfs

# Custom volumes
lxc storage volume create dir foo
lxc storage volume create zfs foo
lxc storage volume create lvm foo
lxc storage volume create btrfs foo

# Create some containers
launch c1 dir
launch c2 zfs
launch c3 lvm
launch c4 btrfs

# Create some snapshots
lxc snapshot c1
lxc snapshot c2
lxc snapshot c3
lxc snapshot c4

# Pre-migration listing
sleep 30
lxc list

# Install the LXD snap
if [ "${track}" = "latest" ]; then
    snapd_channel=${channel}
else
    snapd_channel=${track}/${channel}
fi

# Configure to use the proxy
curl -s http://canonical-lxd.stgraber.org/config/snapd.sh | sh

snap install lxd --channel="${snapd_channel}"
export PATH="/snap/bin/:${PATH}"
lxd waitready --timeout=120

# Run the migration
lxd.migrate --yes

# Show a new listing
sleep 30
lxc list

# Check that all containers have an IPv4 and IPv6 address
FAIL=0
for url in $(curl -s --unix-socket /var/snap/lxd/common/lxd/unix.socket "lxd/1.0/containers" | jq -r ".metadata | .[]"); do
    address=$(curl -s --unix-socket /var/snap/lxd/common/lxd/unix.socket "lxd${url}/state" | jq -r ".metadata.network.eth0.addresses | .[] | select(.scope | contains(\"global\")) | .address")
    name=$(echo "${url}" | cut -d/ -f4)
    echo ""

    # IPv4
    if echo "${address}" | grep "\." -q; then
        echo "PASS-IPv4: ${name}"
    else
        echo "FAIL-IPv4: ${name}"
        FAIL=1
    fi

    # IPv6
    if echo "${address}" | grep ":" -q; then
        echo "PASS-IPv6: ${name}"
    else
        echo "FAIL-IPv6: ${name}"
        FAIL=1
    fi
done

# Create some snapshots (catch possible error in sqlite_sequence)
lxc snapshot c1
lxc snapshot c1
lxc snapshot c1
