#!/bin/sh
set -eu

export DEBIAN_FRONTEND=noninteractive

cleanup() {
    if [ "${FAIL}" = "1" ]; then
        echo ""
        echo "Test failed"
        exit 1
    fi
}

FAIL=1
trap cleanup EXIT HUP INT TERM

# Make sure we're up to date
while :; do
    apt update && break
    sleep 10
done

while :; do
    apt dist-upgrade --yes && break
    sleep 10
done

# Setup the environment
export LXD_BACKEND=$1
apt remove --purge lxd lxd-client lxcfs liblxc1 --yes
apt install zfsutils-linux sqlite3 --yes

# Configure ceph
if [ "${LXD_BACKEND}" = "ceph" ]; then
    mkdir -p /etc/ceph
    (
cat << EOF
[global]
mon_initial_members = ceph01
mon_host = [2001:470:b0f8:1015:216:3eff:fe52:5748]
EOF
    ) > /etc/ceph/ceph.conf

    (
cat << EOF
[client.admin]
    key = AQDxu3dZ8yh8KxAAa5Vlk9kWSD0aCIR7FNGnJQ==
EOF
    ) > /etc/ceph/ceph.client.admin.keyring

    export LXD_CEPH_CLUSTER=ceph
fi

# Setup LXD snap
snap install lxd --edge
snap alias lxd.benchmark lxd-benchmark
lxd waitready
snap stop lxd
nsenter --mount=/run/snapd/ns/lxd.mnt mount --bind /var/lib/snapd/hostfs/srv /srv

# Setup storage
mkfs.ext4 -F /dev/sde
mount /dev/sde /srv
cd /srv

# Get LXD testsuite
git clone https://github.com/lxc/lxd /srv/lxd
cd /srv/lxd/test/

# Run the tests
./perf.sh
tar -zcf /home/ubuntu/artifacts.tar.gz perf.csv

FAIL=0
