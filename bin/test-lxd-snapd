#!/bin/sh
set -eu
channel=${1:-stable}

. /etc/profile.d/apps-bin-path.sh

echo "==> Loading kernel modules"
modprobe ip6table_nat
modprobe ip6table_filter
modprobe ip6table_mangle
modprobe iptable_mangle
modprobe iptable_filter
modprobe iptable_nat

RET=1
cleanup() {
    set +e
    echo "==> Cleaning up"
    snap remove lxd
    [ -e /sys/class/net/lxdbr0 ] && ip link del lxdbr0

    if [ "${RET}" = "0" ]; then
        echo ""
        echo "==> Test passed"
        exit 0
    fi

    echo ""
    echo "==> Test failed"
    exit "${RET}"
}
trap cleanup EXIT HUP INT TERM

echo "==> Installing LXD snap from ${channel}"
snap install lxd "--${channel}"

# shellcheck disable=SC2034
for i in $(seq 12); do
    lxd waitready --timeout=10 >/dev/null 2>&1 && break
done

lxc version

lxc storage create default dir
lxc profile device add default root disk pool=default path=/

lxc network create lxdbr0
lxc profile device add default eth0 nic nictype=bridged parent=lxdbr0 name=eth0

lxc launch images:centos/7 centos
lxc launch ubuntu:16.04 ubuntu

sleep 3
lxc list

lxc delete -f centos
lxc delete -f ubuntu

lxc profile device remove default root
lxc storage delete default

lxc profile device remove default eth0
lxc network delete lxdbr0

RET=0
