#!/bin/sh -eu
[ -e /lxc-ci/etc/config ] && . /lxc-ci/etc/config

if [ "${LXD_GOCACHE:-}" != "true" ]; then
    exit 0
fi

export PATH="${PATH}:/snap/bin"
TEMP_DIR=$(mktemp -d -p /lxc-ci/build/)

cleanup() {
    rm -Rf "${TEMP_DIR}"
}

trap cleanup EXIT HUP INT TERM

ifup lxdbr0 >/dev/null 2>&1 || true

# Clustering bits
git clone -q https://github.com/CanonicalLtd/sqlite "${TEMP_DIR}/sqlite"
cd "${TEMP_DIR}/sqlite"
git log -1 --format=format:%ci%n | sed -e 's/ [-+].*$//;s/ /T/;s/^/D /' > manifest
git log -1 --format=format:%H > manifest.uuid
./configure --enable-debug --enable-replication >/dev/null 2>&1
make >/dev/null 2>&1
cd - >/dev/null

git clone -q https://github.com/freeekanayaka/libco "${TEMP_DIR}/libco"
cd "${TEMP_DIR}/libco"
gcc -c -Wall -fpic libco.c >/dev/null 2>&1
gcc -shared -o libco.so libco.o >/dev/null 2>&1
ar rcs libco.a libco.o >/dev/null 2>&1
cat > libco.pc <<EOF
prefix=/usr
libdir=\${prefix}/lib/$(dpkg-architecture -qDEB_HOST_MULTIARCH)
includedir=\${prefix}/include

Name: libco
Description: Cooperative multithreading library written in C89C
Version: 18
Libs: -L\${libdir} -lco
Cflags: -I\${includedir}
EOF
cd - >/dev/null

git clone -q https://github.com/CanonicalLtd/raft "${TEMP_DIR}/raft"
cd "${TEMP_DIR}/raft"
autoreconf -i >/dev/null 2>&1
./configure --enable-debug >/dev/null 2>&1
make >/dev/null 2>&1
cd - >/dev/null

git clone -q https://github.com/CanonicalLtd/dqlite "${TEMP_DIR}/dqlite"
cd "${TEMP_DIR}/dqlite"
export PKG_CONFIG_PATH="${TEMP_DIR}/sqlite:${TEMP_DIR}/libco:${TEMP_DIR}/raft"
export CFLAGS="-I${TEMP_DIR}/sqlite -I${TEMP_DIR}/libco -I${TEMP_DIR}/raft/include"
export LDFLAGS="-L${TEMP_DIR}/sqlite/.libs -L${TEMP_DIR}/libco -L${TEMP_DIR}/raft/.libs"
autoreconf -i >/dev/null 2>&1
./configure --enable-debug >/dev/null 2>&1
make >/dev/null 2>&1
cd - >/dev/null

# Setup the gimme cache
[ "$(arch)" != "i686" ] || export GIMME_ARCH=x86
export GIMME_ENV_PREFIX="${TEMP_DIR}/gimme/envs/"
export GIMME_VERSION_PREFIX="${TEMP_DIR}/gimme/versions/"
export GOPATH="${TEMP_DIR}/go"
export GOCACHE="${GOPATH}/pkg"
export GO111MODULE=off

[ ! -d /lxc-ci/deps/gimme ] && git clone -q https://github.com/travis-ci/gimme /lxc-ci/deps/gimme

cd /lxc-ci/deps/gimme
git pull -q

OLD_PATH=${PATH}
for version in 1.10.8 1.12 tip; do
    ./gimme "${version}" >/dev/null
    if [ "${version}" = "tip" ]; then
        export GOROOT="${TEMP_DIR}/gimme/versions/go"
    else
        goroot="$(readlink -f "${TEMP_DIR}/gimme/versions/go${version}"*)"
        export GOROOT="${goroot}"
    fi
    export PATH="${GOROOT}/bin:${OLD_PATH}"

    go get github.com/rogpeppe/godeps >/dev/null || true
    go get github.com/remyoudompheng/go-misc/deadcode >/dev/null || true
    go get github.com/snapcore/snapd/i18n/xgettext-go >/dev/null || true
    go get github.com/client9/misspell/cmd/misspell >/dev/null || true
    go get github.com/gordonklaus/ineffassign >/dev/null || true
    go get golang.org/x/lint/golint >/dev/null || true

    mkdir -p "${GOPATH}/bin" && mv "${GOPATH}/bin" "${GOPATH}/bin.$(go version | cut -d' ' -f3)"
    mkdir -p "${GOPATH}/pkg" && mv "${GOPATH}/pkg" "${GOPATH}/pkg.$(go version | cut -d' ' -f3)"
done

cd - >/dev/null

# Setup the Go cache
# shellcheck disable=SC1090
. "${TEMP_DIR}"/gimme/envs/go1.10*.env 2>/dev/null
mkdir -p "${TEMP_DIR}/go"
export GOPATH=${TEMP_DIR}/go
go get -d -t github.com/lxc/lxd/... >/dev/null || echo "Failed to download LXD dependencies"

# Build test image
mkdir "${TEMP_DIR}/image"
cd "${TEMP_DIR}/image"
lxc image export images:alpine/edge --quiet
unsquashfs -no-progress rootfs.squashfs >/dev/null
mv squashfs-root/ rootfs
tar Jxf lxd.tar.xz
rm lxd.tar.xz rootfs.squashfs
tar -C . -cf "${TEMP_DIR}/testimage.tar" *
rm -rf "${TEMP_DIR}/image"
cd - >/dev/null

# Move things into place
rm -Rf /lxc-ci/build/cache.new
mkdir -p /lxc-ci/build/cache.new
rm -Rf "${TEMP_DIR}/go/pkg" "${TEMP_DIR}/go/bin"
mv "${TEMP_DIR}/gimme" /lxc-ci/build/cache.new/gimme
mv "${TEMP_DIR}/go" /lxc-ci/build/cache.new/go
mv "${TEMP_DIR}/sqlite" /lxc-ci/build/cache.new/sqlite
mv "${TEMP_DIR}/libco" /lxc-ci/build/cache.new/libco
mv "${TEMP_DIR}/raft" /lxc-ci/build/cache.new/raft
mv "${TEMP_DIR}/dqlite" /lxc-ci/build/cache.new/dqlite
mv "${TEMP_DIR}/testimage.squashfs" /lxc-ci/build/cache.new/testimage.squashfs
chmod -R o+rX /lxc-ci/build/cache.new
rm -Rf /lxc-ci/build/cache.old
[ -e "/lxc-ci/build/cache" ] && mv /lxc-ci/build/cache /lxc-ci/build/cache.old
mv /lxc-ci/build/cache.new /lxc-ci/build/cache
rm -Rf /home/jenkins/.cache/go-build/
