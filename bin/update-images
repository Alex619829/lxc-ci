#!/bin/sh -eu
export PATH="/snap/bin/:${PATH}"

[ -e /lxc-ci/etc/config ] && . /lxc-ci/etc/config

cleanup() {
    set +e
    lxc delete build-distrobuilder-cache -f >/dev/null 2>&1
    lxc delete build-lxc-cache -f >/dev/null 2>&1

    exit 0
}
trap cleanup EXIT HUP INT TERM

HOST="http://jenkins01.srv.mtl.stgraber.net:8080"

build_distrobuilder() {
    if [ "${DISTROBUILDER_ARCHES:-}" = "" ]; then
        return
    fi

    for arch in ${DISTROBUILDER_ARCHES}; do
        lxc delete -f build-distrobuilder-cache >/dev/null 2>&1 || true
        curl -s "${HOST}/job/lxc-ci-artifacts/architecture=${arch},artifact=distrobuilder-image,restrict=lxc-priv,variant=default/lastSuccessfulBuild/artifact/build-distrobuilder-cache.tar.xz" | lxc import /dev/stdin --quiet
        lxc delete -f "cache-distrobuilder-${arch}" >/dev/null 2>&1 || true
        lxc move build-distrobuilder-cache "cache-distrobuilder-${arch}"
    done
}

build_lxc() {
    if [ "${LXC_ARCHES:-}" = "" ]; then
        return
    fi

    for arch in ${LXC_ARCHES}; do
        lxc delete -f build-lxc-cache >/dev/null 2>&1 || true
        curl -s "${HOST}/job/lxc-ci-artifacts/architecture=${arch},artifact=lxc-image,restrict=lxc-priv,variant=default/lastSuccessfulBuild/artifact/build-lxc-cache.tar.xz" | lxc import /dev/stdin --quiet
        lxc delete -f "cache-lxc-${arch}" >/dev/null 2>&1 || true
        lxc move build-lxc-cache "cache-lxc-${arch}"
    done
}

build_distrobuilder
build_lxc

exit 0
