image:
  distribution: centos

source:
  downloader: centos-http
  url: http://centos.mirror.iweb.ca
  keyserver: keyserver.ubuntu.com
  keys:
    - 6341AB2753D78A78A7C27BB124C6A8A7F4A80EB5
    - C1DAC52D1664E8A4386DBA430946FCA2C105B9DE
  variant: minimal

targets:
  lxc:
    create-message: |
        You just created a {{ image.description }} container.

    config:
      - type: all
        before: 5
        content: |-
          lxc.include = LXC_TEMPLATE_CONFIG/centos.common.conf

      - type: user
        before: 5
        content: |-
          lxc.include = LXC_TEMPLATE_CONFIG/centos.userns.conf

      - type: all
        after: 4
        content: |-
          lxc.include = LXC_TEMPLATE_CONFIG/common.conf

      - type: user
        after: 4
        content: |-
          lxc.include = LXC_TEMPLATE_CONFIG/userns.conf

      - type: all
        content: |-
          lxc.arch = {{ image.architecture_kernel }}

files:
 - name: hostname
   path: /etc/hostname
   generator: hostname

 - name: hosts
   path: /etc/hosts
   generator: hosts

 - name: ifcfg-eth0
   path: /etc/sysconfig/network-scripts/ifcfg-eth0
   generator: dump
   content: |-
     DEVICE=eth0
     BOOTPROTO=dhcp
     ONBOOT=yes
     HOSTNAME=LXC_NAME
     NM_CONTROLLED=no
     TYPE=Ethernet
     MTU=
     DHCP_HOSTNAME=`hostname`

 - name: network
   path: /etc/sysconfig/network
   generator: dump
   content: |-
     NETWORKING=yes
     HOSTNAME=LXC_NAME

 - name: ifcfg-eth0.lxd
   path: /etc/sysconfig/network-scripts/ifcfg-eth0
   generator: template
   content: |-
     DEVICE=eth0
     BOOTPROTO=dhcp
     ONBOOT=yes
     HOSTNAME={{ container.name }}
     NM_CONTROLLED=no
     TYPE=Ethernet
     MTU=
     DHCP_HOSTNAME=`hostname`

 - name: network.lxd
   path: /etc/sysconfig/network
   generator: template
   content: |-
     NETWORKING=yes
     HOSTNAME={{ container.name }}

packages:
    manager: yum
    update: true
    cleanup: true

    sets:
     - packages:
        - cronie-noanacron
       action: install

     - packages:
        - sendmail
       action: install
       releases:
        - 6

     - packages:
        - audit
        - authconfig
        - b43-openfwwf
        - bridge-utils
        - cronie-anacron
        - cryptsetup-luks
        - cryptsetup-luks-libs
        - dash
        - device-mapper
        - device-mapper-event
        - device-mapper-event-libs
        - device-mapper-libs
        - device-mapper-multipath
        - device-mapper-multipath-libs
        - device-mapper-persistent-data
        - dracut
        - dracut-kernel
        - e2fsprogs
        - e2fsprogs-libs
        - efibootmgr
        - fuse
        - gpg-pubkey
        - grub
        - grubby
        - iptables-ipv6
        - iscsi-initiator-utils
        - kbd
        - kbd-misc
        - kernel
        - kernel
        - kernel-firmware
        - kpartx
        - libaio
        - libss
        - libudev
        - lvm2
        - lvm2-libs
        - m4
        - mdadm
        - mysql-libs
        - newt
        - newt-python
        - openssh-server
        - pciutils-libs
        - postfix
        - selinux-policy
        - selinux-policy-targeted
        - slang
        - sudo
        - system-config-firewall-base
        - xfsprogs
       action: remove
       releases:
        - 6

     - packages:
        - aic94xx-firmware
        - alsa-firmware
        - alsa-lib
        - alsa-tools-firmware
        - audit
        - biosdevname
        - btrfs-progs
        - centos-logos
        - cronie-anacron
        - dbus-glib
        - dbus-python
        - dmidecode
        - dracut-config-rescue
        - dracut-network
        - e2fsprogs
        - e2fsprogs-libs
        - ebtables
        - ethtool
        - firewalld
        - firewalld-filesystem
        - fxload
        - gobject-introspection
        - gpg-pubkey
        - groff-base
        - grubby
        - hwdata
        - iprutils
        - ipset
        - ipset-libs
        - irqbalance
        - ivtv-firmware
        - iwl1000-firmware
        - iwl100-firmware
        - iwl105-firmware
        - iwl135-firmware
        - iwl2000-firmware
        - iwl2030-firmware
        - iwl3160-firmware
        - iwl3945-firmware
        - iwl4965-firmware
        - iwl5000-firmware
        - iwl5150-firmware
        - iwl6000-firmware
        - iwl6000g2a-firmware
        - iwl6000g2b-firmware
        - iwl6050-firmware
        - iwl7260-firmware
        - iwl7265-firmware
        - jansson
        - kbd
        - kbd-legacy
        - kbd-misc
        - kernel
        - kernel
        - kernel-tools
        - kernel-tools-libs
        - kexec-tools
        - libdaemon
        - libdrm
        - libndp
        - libnl3
        - libnl3-cli
        - libpciaccess
        - libpipeline
        - libselinux-python
        - libss
        - libsysfs
        - libteam
        - linux-firmware
        - lshw
        - lsscsi
        - lzo
        - man-db
        - mariadb-libs
        - microcode_ctl
        - mozjs17
        - NetworkManager
        - NetworkManager-libnm
        - NetworkManager-team
        - NetworkManager-tui
        - NetworkManager-wifi
        - newt
        - numactl-libs
        - openssh-server
        - parted
        - pciutils-libs
        - plymouth
        - plymouth-core-libs
        - plymouth-scripts
        - polkit
        - polkit-pkla-compat
        - postfix
        - python-configobj
        - python-decorator
        - python-firewall
        - python-gobject-base
        - python-linux-procfs
        - python-perf
        - python-pyudev
        - python-schedutils
        - python-slip
        - python-slip-dbus
        - selinux-policy
        - selinux-policy-targeted
        - sg3_utils
        - sg3_utils-libs
        - slang
        - snappy
        - sudo
        - systemd-sysv
        - teamd
        - tuned
        - virt-what
        - wpa_supplicant
        - xfsprogs
       action: remove
       releases:
        - 7

actions:
  - trigger: post-unpack
    action: |-
      #!/bin/sh

      # Create required files
      touch /etc/mtab /etc/fstab
      
      # Install initial package set
      cd /mnt/cdrom/Packages
      rpm -ivh --nodeps $(ls rpm-*.rpm | head -n1)
      rpm -ivh --nodeps $(ls yum-*.rpm | head -n1)

      # Add cdrom repo
      mkdir -p /etc/yum.repos.d
      cat <<- EOF > /etc/yum.repos.d/cdrom.repo
      [cdrom]
      name=Install CD-ROM
      baseurl=file:///mnt/cdrom
      enabled=0
      gpgcheck=1
      EOF

  - trigger: post-unpack
    action: |-
      echo gpgkey=file:///mnt/cdrom/RPM-GPG-KEY-CentOS-6 >> /etc/yum.repos.d/cdrom.repo
    releases:
      - 6

  - trigger: post-unpack
    action: |-
      echo gpgkey=file:///mnt/cdrom/RPM-GPG-KEY-CentOS-7 >> /etc/yum.repos.d/cdrom.repo
    releases:
      - 7

  - trigger: post-unpack
    action: |-
      yum --disablerepo=\* --enablerepo=cdrom -y reinstall yum

  - trigger: post-unpack
    action: |-
      yum --disablerepo=\* --enablerepo=cdrom -y groupinstall "Core"
    releases:
      - 6

  - trigger: post-unpack
    action: |-
      yum --disablerepo=\* --enablerepo=cdrom -y groupinstall "Minimal Install"
    releases:
      - 7

  - trigger: post-unpack
    action: |-
      rm -rf /mnt/cdrom /etc/yum.repos.d/cdrom.repo

  - trigger: post-packages
    action: |-
      #!/bin/sh
      rm -rf /var/cache/yum
