- project:
    name: lxc-github-commit
    branch: ""
    jobs:
    - "lxc-github-commit-${branch}":
      branch: master
      pkg_version: 3.2.1+master
    - "lxc-github-commit-${branch}":
      branch: stable-2.0
      pkg_version: 2.0.11+stable
    - "lxc-github-commit-${branch}":
      branch: stable-3.0
      pkg_version: 3.0.4+stable

- job-template:
    name: "lxc-github-commit-${branch}"
    concurrent: false
    description: Triggered by new Github pull requests.
    node: master
    project-type: matrix

    builders:
    - shell: |-
        cd /lxc
        exec sudo /lxc-ci/bin/testbuild-${compiler} https://github.com/lxc/lxc ${branch} ${GIT_COMMIT} --use-daily

    - trigger-builds:
      - project:
        - lxc-build-android
        - lxc-build-tarballs
        predefined-parameters: |-
          sha1=${GIT_COMMIT}
          branch=${branch}

      - project:
        - lxc-build-ubuntu-source
        predefined-parameters: |-
          sha1=${GIT_COMMIT}
          pkg_version=${pkg_version}
          pkg_branch=ppa-daily
          upload_target=lxc-git-${branch}
          branch=${branch}

    properties:
    - build-discarder:
        days-to-keep: 7

    - github:
        url: https://github.com/lxc/lxc/

    - raw:
        !include: ../includes/webhook.yaml.inc

    scm:
    - git:
        url: https://github.com/lxc/lxc
        branches:
          - ${branch}
        refspec: "+refs/pull/*:refs/remotes/origin/pr/* +refs/heads/*:refs/remotes/origin/*"

    triggers:
    - github

    axes:
    - axis:
        name: compiler
        type: user-defined
        values:
        - gcc
        - clang

    - axis:
        name: arch
        type: slave
        values:
        - amd64
        - i386

    - axis:
        name: restrict
        type: slave
        values:
        - lxc-priv

    publishers:
    - archive:
        artifacts: "*.tar.gz"
        allow-empty: true
        fingerprint: true

    - aggregate-tests:
        include-failed-builds: true

    - naginator:
        rerun-unstable-builds: true
        rerun-matrix-part:  true
        progressive-delay-increment: 300
        progressive-delay-maximum: 10800
        max-failed-builds: 3

    - workspace-cleanup:
        fail-build: false

    wrappers:
    - ansicolor:
        colormap: css
